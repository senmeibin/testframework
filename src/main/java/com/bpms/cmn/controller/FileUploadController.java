package com.bpms.cmn.controller;import com.bpms.cmn.utility.AccessUtils;import com.bpms.core.consts.AppCodeConsts;import com.bpms.core.consts.CmnConsts;import com.bpms.core.entity.DropdownEntity;import com.bpms.core.utils.CollectionUtils;import com.bpms.core.utils.DateUtils;import com.bpms.core.utils.ZipUtils;import com.bpms.sys.controller.AttachmentController;import com.bpms.sys.entity.ext.AttachmentExt;import org.apache.commons.io.IOUtils;import org.apache.commons.lang3.StringUtils;import org.springframework.http.HttpStatus;import org.springframework.http.ResponseEntity;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.bind.annotation.RequestParam;import java.io.File;import java.io.IOException;import java.io.OutputStream;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.zip.ZipOutputStream;/** * 附件文件上传控制器类 */@Controller(value = "CmnFileUploadController")@RequestMapping("/cmn/fileupload")public class FileUploadController extends AttachmentController {    /**     * 操作手册上传/下载列表画面显示     *     * @return 操作手册上传/下载列表画面     * @throws IOException     * @throws IllegalAccessException     * @throws InstantiationException     */    @Override    @RequestMapping(value = {"list", ""}, method = RequestMethod.GET)    public String list(Model model) throws IllegalAccessException, IOException, InstantiationException {        String isReadonly = this.getRequest().getParameter("isReadonly");        //操作手册上传必须具有管理员权限        if (StringUtils.equals(isReadonly, Boolean.FALSE.toString()) || StringUtils.isEmpty(isReadonly)) {            if (!(AccessUtils.isSystemManagement() || AccessUtils.isItSupport())) {                return "error/401";            }        }        //设置查询模块名称        this.setModuleName(model);        //初始化数据字典        this.initOptionList(model);        //注：各个模块动态加载，返回固定的JSP路径        return "cmn/fileupload/FileUploadList";    }    /**     * 初始化下拉框选项内容     *     * @param model Model对象     * @throws IllegalAccessException     * @throws IOException     */    @Override    public void initOptionList(Model model) throws IllegalAccessException, IOException {        Map<String, Object> dicMap = new HashMap<>(16);        //模块名称        List<DropdownEntity> moduleNameList = this.getDictionaryList("CMN005");        if (CollectionUtils.isNotEmpty(moduleNameList)) {            for (DropdownEntity dropdownEntity : moduleNameList) {                dropdownEntity.setSubCd(dropdownEntity.getSubName());            }        }        dicMap.put("moduleName", moduleNameList);        model.addAttribute("jsonOptionList_" + this.getEntityName(), this.toJSON(dicMap, true));    }    /**     * 附件文件打包下载     *     * @param relationUid 外键UID     * @return ResponseEntity     * @throws IOException     */    @RequestMapping(value = "packDownload", method = RequestMethod.GET)    public ResponseEntity<byte[]> packDownload(@RequestParam("relationUid") String relationUid) throws IOException {        Map<String, Object> condition = new HashMap<>();        condition.put("main.relation_uid$in", relationUid);        //取得附件文件实体        List<AttachmentExt> list = attachmentService.search(condition);        //附件文件实体不存在的场合        if (CollectionUtils.isEmpty(list)) {            this.getResponse().sendRedirect("/error/FileNotFound");            if (log.isInfoEnabled()) {                log.info("附件文体不存在。");            }            return null;        }        try {            //文件名称            String fileName = this.convertDownloadFileName("附件下载_" + DateUtils.getNowDateString(CmnConsts.DATE_FORMAT_SHORT) + ".zip");            //设置输出的格式            this.getResponse().reset();            this.getResponse().setContentType("application/zip");            this.getResponse().setHeader("Content-Disposition", "attachment; filename=\"" + fileName + "\"");            OutputStream outputStream = this.getResponse().getOutputStream();            //创建文件流            ZipOutputStream zos = new ZipOutputStream(outputStream);            //系统中文件上传的根目录 取得            String uploadPath = this.parameterService.getValue(AppCodeConsts.APP_COMMON, "FILE_UPLOAD_PATH", this.getRequest().getServletContext().getRealPath("/"));            List<File> files = new ArrayList<>();            for (int i = 0; i < list.size(); i++) {                File file = new File(uploadPath + list.get(i).getFilePath());                //忽略不存在的文件                if (file.exists()) {                    files.add(file);                }                else {                    log.error("{}文件存在", list.get(i).getFileName());                }            }            ZipUtils.zipFiles(files.toArray(new File[files.size()]), DateUtils.getNowDateString(CmnConsts.DATE_FORMAT_SHORT) + "/", zos);            //关闭流            IOUtils.closeQuietly(zos);            IOUtils.closeQuietly(outputStream);        } catch (IOException e) {            //报错  重定向FileNotFound页面            this.getResponse().sendRedirect("/error/FileNotFound");            if (log.isInfoEnabled()) {                log.info("附件文体不存在。");            }            return null;        }        return new ResponseEntity<>(HttpStatus.OK);    }    /**     * 根据各业务页面设置不同的模块名称     *     * @param model Model对应     */    protected void setModuleName(Model model) {        //如有需要在子类实现    }}